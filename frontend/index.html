<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fruit Traceability DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="abi.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <div class="max-w-3xl mx-auto p-6">
      <h2 class="text-3xl font-bold mb-4 text-center">
        üçé Fruit Traceability DApp
      </h2>
      <div class="text-center mb-8">
        <button
          id="connectButton"
          onclick="connectWallet()"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Connect MetaMask
        </button>
        <p id="walletAddress" class="mt-2 text-sm text-gray-700"></p>
      </div>

      <div class="space-y-6">
        <!-- Add Batch -->
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-xl font-semibold mb-4">Add Batch</h3>
          <div class="space-y-2">
            <input
              id="productName"
              placeholder="Product Name"
              class="w-full p-2 border rounded"
            />
            <input
              id="originFarm"
              placeholder="Origin Farm"
              class="w-full p-2 border rounded"
            />
            <input
              id="farmerName"
              placeholder="Farmer Name"
              class="w-full p-2 border rounded"
            />
            <input
              id="harvestDate"
              type="date"
              class="w-full p-2 border rounded"
            />
            <input
              id="quality"
              placeholder="Initial Quality"
              class="w-full p-2 border rounded"
            />
            <button
              onclick="addBatch()"
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
            >
              Add Batch
            </button>
          </div>
        </div>

        <!-- Update Transport -->
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-xl font-semibold mb-4">Update Transport</h3>
          <div class="space-y-2">
            <input
              id="batchIdTransport"
              placeholder="Batch ID"
              class="w-full p-2 border rounded"
            />
            <input
              id="transporterName"
              placeholder="Transporter Name"
              class="w-full p-2 border rounded"
            />
            <input
              id="transportDetails"
              placeholder="Transport Details"
              class="w-full p-2 border rounded"
            />
            <input
              id="transportDate"
              type="date"
              class="w-full p-2 border rounded"
            />
            <input
              id="qualityTransport"
              placeholder="Quality During Transport"
              class="w-full p-2 border rounded"
            />
            <button
              onclick="updateTransportInfo()"
              class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600"
            >
              Update Transport
            </button>
          </div>
        </div>

        <!-- Update Warehouse -->
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-xl font-semibold mb-4">Update Warehouse</h3>
          <div class="space-y-2">
            <input
              id="batchIdWarehouse"
              placeholder="Batch ID"
              class="w-full p-2 border rounded"
            />
            <input
              id="warehouseName"
              placeholder="Warehouse Name"
              class="w-full p-2 border rounded"
            />
            <input
              id="warehouseDetails"
              placeholder="Warehouse Details"
              class="w-full p-2 border rounded"
            />
            <input
              id="warehouseDate"
              type="date"
              class="w-full p-2 border rounded"
            />
            <input
              id="qualityWarehouse"
              placeholder="Quality in Warehouse"
              class="w-full p-2 border rounded"
            />
            <button
              onclick="updateWarehouseInfo()"
              class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
            >
              Update Warehouse
            </button>
          </div>
        </div>

        <!-- Update Retail -->
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-xl font-semibold mb-4">Update Retail</h3>
          <div class="space-y-2">
            <input
              id="batchIdRetail"
              placeholder="Batch ID"
              class="w-full p-2 border rounded"
            />
            <input
              id="retailerName"
              placeholder="Retailer Name"
              class="w-full p-2 border rounded"
            />
            <input
              id="retailStore"
              placeholder="Retail Store"
              class="w-full p-2 border rounded"
            />
            <input
              id="retailDate"
              type="date"
              class="w-full p-2 border rounded"
            />
            <input
              id="qualityRetail"
              placeholder="Final Retail Quality"
              class="w-full p-2 border rounded"
            />
            <button
              onclick="updateRetailerInfo()"
              class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700"
            >
              Update Retail
            </button>
          </div>
        </div>

        <!-- Get Batch Info -->
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-xl font-semibold mb-4">Get Batch by Farmer Name</h3>
          <div class="space-y-2">
            <input
              id="farmerNameInput"
              placeholder="Farmer Name"
              class="w-full p-2 border rounded"
            />
            <button
              onclick="getBatch()"
              class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
            >
              Get Batch
            </button>
            <pre
              id="batchResult"
              class="bg-gray-100 p-3 rounded text-sm overflow-auto max-h-64"
            ></pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      let web3;
      let contract;

      async function connectWallet() {
        const connectButton = document.getElementById("connectButton");
        const walletAddressEl = document.getElementById("walletAddress");

        if (window.ethereum) {
          try {
            const accounts = await window.ethereum.request({
              method: "eth_requestAccounts",
            });
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(abi, contractAddress);
            const account = accounts[0];
            connectButton.textContent = "Connected";
            connectButton.disabled = true;
            walletAddressEl.textContent = `Wallet: ${account}`;
          } catch (err) {
            alert("Connection failed: " + err.message);
          }
        } else {
          alert("MetaMask not found!");
        }
      }

      window.addEventListener("load", async () => {
        if (window.ethereum && window.ethereum.selectedAddress) {
          const accounts = await window.ethereum.request({
            method: "eth_accounts",
          });
          if (accounts.length > 0) {
            const connectButton = document.getElementById("connectButton");
            const walletAddressEl = document.getElementById("walletAddress");
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(abi, contractAddress);
            connectButton.textContent = "Connected";
            connectButton.disabled = true;
            walletAddressEl.textContent = `Wallet: ${accounts[0]}`;
          }
        }
      });

      async function addBatch() {
        const accounts = await web3.eth.getAccounts();
        const productName = document.getElementById("productName").value;
        const originFarm = document.getElementById("originFarm").value;
        const farmerName = document.getElementById("farmerName").value;
        const harvestDateInput = document.getElementById("harvestDate").value;
        const quality = document.getElementById("quality").value;

        if (
          !productName ||
          !originFarm ||
          !farmerName ||
          !harvestDateInput ||
          !quality
        ) {
          alert("Please fill in all fields.");
          return;
        }

        const harvestDate = Math.floor(
          new Date(harvestDateInput).getTime() / 1000
        );

        await contract.methods
          .addBatch(productName, originFarm, farmerName, harvestDate, quality)
          .send({ from: accounts[0] });

        alert("Batch added successfully!");
      }

      async function updateTransportInfo() {
        const accounts = await web3.eth.getAccounts();
        const batchId = document.getElementById("batchIdTransport").value;
        const transporterName =
          document.getElementById("transporterName").value;
        const transportDetails =
          document.getElementById("transportDetails").value;
        const transportDateInput =
          document.getElementById("transportDate").value;
        const quality = document.getElementById("qualityTransport").value;

        if (
          !batchId ||
          !transporterName ||
          !transportDetails ||
          !transportDateInput ||
          !quality
        ) {
          alert("Please fill in all fields.");
          return;
        }

        const transportDate = Math.floor(
          new Date(transportDateInput).getTime() / 1000
        );

        await contract.methods
          .updateTransportInfo(
            batchId,
            transporterName,
            transportDetails,
            transportDate,
            quality
          )
          .send({ from: accounts[0] });

        alert("Transport updated!");
      }

      async function updateWarehouseInfo() {
        const accounts = await web3.eth.getAccounts();
        const batchId = document.getElementById("batchIdWarehouse").value;
        const warehouseName = document.getElementById("warehouseName").value;
        const warehouseDetails =
          document.getElementById("warehouseDetails").value;
        const warehouseDateInput =
          document.getElementById("warehouseDate").value;
        const quality = document.getElementById("qualityWarehouse").value;

        if (
          !batchId ||
          !warehouseName ||
          !warehouseDetails ||
          !warehouseDateInput ||
          !quality
        ) {
          alert("Please fill in all fields.");
          return;
        }

        const warehouseDate = Math.floor(
          new Date(warehouseDateInput).getTime() / 1000
        );

        await contract.methods
          .updateWarehouseInfo(
            batchId,
            warehouseName,
            warehouseDetails,
            warehouseDate,
            quality
          )
          .send({ from: accounts[0] });

        alert("Warehouse updated!");
      }

      async function updateRetailerInfo() {
        const accounts = await web3.eth.getAccounts();
        const batchId = document.getElementById("batchIdRetail").value;
        const retailerName = document.getElementById("retailerName").value;
        const retailStore = document.getElementById("retailStore").value;
        const retailDateInput = document.getElementById("retailDate").value;
        const quality = document.getElementById("qualityRetail").value;

        if (
          !batchId ||
          !retailerName ||
          !retailStore ||
          !retailDateInput ||
          !quality
        ) {
          alert("Please fill in all fields.");
          return;
        }

        const retailDate = Math.floor(
          new Date(retailDateInput).getTime() / 1000
        );

        await contract.methods
          .updateRetailerInfo(
            batchId,
            retailerName,
            retailStore,
            retailDate,
            quality
          )
          .send({ from: accounts[0] });

        alert("Retail info updated!");
      }

      async function getBatch() {
        const farmerName = document.getElementById("farmerNameInput").value;
        if (!farmerName) {
          alert("Enter a farmer name");
          return;
        }

        try {
          const batchIds = await contract.methods
            .getBatchesByFarmer(farmerName)
            .call();
          const batchDetails = [];

          for (const batchId of batchIds) {
            const batch = await contract.methods.batches(batchId).call();
            const formattedBatch = {
              batchId: batch.batchId?.toString(),
              productName: batch.farmer?.productName || "",
              originFarm: batch.farmer?.originFarm || "",
              farmerName: batch.farmer?.farmerName || "",
              harvestDate: batch.farmer?.harvestDate
                ? formatDateFromTimestamp(batch.farmer.harvestDate)
                : "",
              transporterName: batch.transport?.transporterName || "",
              transportDetails: batch.transport?.transportDetails || "",
              transportDate: batch.transport?.transportDate
                ? formatDateFromTimestamp(batch.transport.transportDate)
                : "",
              warehouseName: batch.warehouse?.warehouseName || "",
              warehouseDetails: batch.warehouse?.warehouseDetails || "",
              warehouseDate: batch.warehouse?.warehouseDate
                ? formatDateFromTimestamp(batch.warehouse.warehouseDate)
                : "",
              retailerName: batch.retailer?.retailerName || "",
              retailStore: batch.retailer?.retailStore || "",
              retailDate: batch.retailer?.retailDate
                ? formatDateFromTimestamp(batch.retailer.retailDate)
                : "",
              quality: batch.quality || "",
              currentOwner: batch.currentOwner || "",
              status: batch.status || "",
            };
            batchDetails.push(formattedBatch);
          }

          document.getElementById("batchResult").textContent = JSON.stringify(
            batchDetails,
            null,
            2
          );
        } catch (err) {
          document.getElementById("batchResult").textContent =
            "Error fetching batch: " + err.message;
        }
      }

      function formatDateFromTimestamp(timestamp) {
        const ts =
          typeof timestamp === "bigint" ? Number(timestamp) : timestamp;
        const date = new Date(ts * 1000);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }
    </script>
  </body>
</html>
