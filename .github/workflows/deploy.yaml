name: Build, Push Docker Images, and Deploy to Kubernetes

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up Docker for both frontend and backend
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # Step 3: Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 4: Build and push backend Docker image
      - name: Build and push backend Docker image
        run: |
          cd backend
          docker build -t shayandanish/food-traceability-backend:v2 .
          docker push shayandanish/food-traceability-backend:v2

      # Step 5: Build and push frontend Docker image
      - name: Build and push frontend Docker image
        run: |
          cd frontend
          docker build -t shayandanish/food-traceability-frontend:latest .
          docker push shayandanish/food-traceability-frontend:latest

      # Step 6: Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      # Step 7: Configure Kubernetes context (FIXED)
      - name: Configure Kubernetes context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
          # Verify connection
          kubectl cluster-info
          kubectl get nodes

      # Step 8: Deploy backend to Kubernetes
      - name: Deploy backend to Kubernetes
        run: |
          echo "Deploying backend to Kubernetes..."
          export KUBECONFIG=$HOME/.kube/config
          kubectl set image deployment/backend-deployment backend=shayandanish/food-traceability-backend:v2 -n default
          kubectl rollout restart deployment/backend-deployment -n default
          kubectl rollout status deployment/backend-deployment -n default --timeout=300s

      # Step 9: Deploy frontend to Kubernetes
      - name: Deploy frontend to Kubernetes
        run: |
          echo "Deploying frontend to Kubernetes..."
          export KUBECONFIG=$HOME/.kube/config
          kubectl set image deployment/frontend-deployment frontend=shayandanish/food-traceability-frontend:latest -n default
          kubectl rollout restart deployment/frontend-deployment -n default
          kubectl rollout status deployment/frontend-deployment -n default --timeout=300s

      # Step 10: Verify deployment
      - name: Verify deployment
        run: |
          export KUBECONFIG=$HOME/.kube/config
          echo "=== Verification ==="
          kubectl get deployment backend-deployment -n default
          kubectl get deployment frontend-deployment -n default
          kubectl get pods -n default
          # Check backend pod logs
          echo "=== Backend Pod Logs ==="
          POD_NAME=$(kubectl get pods -n default -l app=backend -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          if [ -n "$POD_NAME" ]; then
            echo "Backend pod: $POD_NAME"
            kubectl logs -n default $POD_NAME --tail=10
          else
            echo "No backend pod found"
          fi
          # Check frontend pod logs
          echo "=== Frontend Pod Logs ==="
          POD_NAME=$(kubectl get pods -n default -l app=frontend -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          if [ -n "$POD_NAME" ]; then
            echo "Frontend pod: $POD_NAME"
            kubectl logs -n default $POD_NAME --tail=10
          else
            echo "No frontend pod found"
          fi
