name: Build, Push Docker Images, and Deploy to Kubernetes

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up Docker for both frontend and backend
      - name: Set up Docker
        uses: docker/setup-buildx-action@v1

      # Step 3: Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 4: Build Docker images for backend and frontend (if needed)
      - name: Build backend Docker image
        run: |
          cd backend
          docker build -t shayandanish/food-traceability-backend:v2 .
          docker push shayandanish/food-traceability-backend:v2

      - name: Build frontend Docker image
        run: |
          cd frontend
          docker build -t shayandanish/food-traceability-frontend:latest .
          docker push shayandanish/food-traceability-frontend:latest

      # Step 5: Set up kubectl for Kubernetes interaction
      - name: Set up kubectl
        uses: azure/setup-kubectl@v1
        with:
          version: 'v1.21.2'

      - name: Configure Kubernetes context
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig.yaml
          export KUBECONFIG=kubeconfig.yaml

      # Step 6: Deploy backend to Kubernetes
      - name: Deploy backend to Kubernetes
        run: |
          echo "Deploying backend to Kubernetes..."
          kubectl set image deployment/backend-deployment fyp-backend=shayandanish/food-traceability-backend:v2 -n default
          kubectl rollout restart deployment/backend-deployment -n default
          kubectl rollout status deployment/backend-deployment -n default --timeout=300s

      # Step 7: Deploy frontend to Kubernetes
      - name: Deploy frontend to Kubernetes
        run: |
          echo "Deploying frontend to Kubernetes..."
          kubectl set image deployment/frontend-deployment fyp-frontend=shayandanish/food-traceability-frontend:latest -n default
          kubectl rollout restart deployment/frontend-deployment -n default
          kubectl rollout status deployment/frontend-deployment -n default --timeout=300s

      # Step 8: Verify deployment
      - name: Verify deployment
        run: |
          echo "=== Verification ==="
          kubectl get deployment backend-deployment -n default
          kubectl get deployment frontend-deployment -n default
          kubectl get pods -n default
          # Check pod logs for debugging purposes
          POD_NAME=$(kubectl get pods -n default -l app=fyp-backend -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          if [ -n "$POD_NAME" ]; then
            echo "Backend pod logs (last 5 lines):"
            kubectl logs -n default $POD_NAME --tail=5
          fi
          POD_NAME=$(kubectl get pods -n default -l app=fyp-frontend -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          if [ -n "$POD_NAME" ]; then
            echo "Frontend pod logs (last 5 lines):"
            kubectl logs -n default $POD_NAME --tail=5
          fi

